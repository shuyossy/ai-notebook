# CLAUDE.md

このファイルは、Claude Code (claude.ai/code) がこのリポジトリでコードを作業する際のガイダンスを提供します。

## 共通コマンド

### 開発環境
```bash
npm start
```

### リント・フォーマット
```bash
npm run check # TypeScriptの型チェック
```
加えて、IDEからのエラー情報も読み取るようにしてください

### テスト
```bash
npm test
```

### データベース関連
```bash
npm run db:generate
npm run db:push
npm run db:migrate
npm run db:prepare
npm run db:studio
```

## アーキテクチャ概要

### プロジェクト構成
本プロジェクト「AIKATA」は、Electron製のAIデスクトップアプリケーションで、以下の機能を提供する
- アプリケーション設定機能
  - 以下を設定できる
  - アプリ内で利用するAI APIのURL・キー
  - 後述のチャット機能のユーザカスタムシステムプロンプト
  - MCPサーバ設定
   - チャット機能で利用可能なMCPサーバを指定する
  - アプリが利用するDB（ローカルにSQLiteとして保存）のパス
    - DBにはチャット履歴やドキュメントの要約情報（チャット機能でシステムプロンプトに検索可能なドキュメントを提示するために利用する）を保存する
  - Redmine・GitLabのAPI・アクセストークン
    - チャット機能で利用
  - ドキュメント登録用ディレクトリ
    - このアプリではドキュメントはword,excel,pdf,txtのような文字列を含むファイルを指す
    - このアプリでは、アプリ内で利用するドキュメントを予め指定のフォルダに保存しておく
    - 後述のドキュメント登録機能でフォルダに格納されているドキュメントのテキストを抽出して、アプリ内の各機能でドキュメントを利用できるようにする
      - AIに対してドキュメントを連携する際は、抽出したテキストをコンテキストに含める形で連携することを想定する
- ドキュメント登録機能
  - アプリ内の全機能でユーザが登録したドキュメントから抽出したテキスト情報にアクセスできるようにする
  - 抽出したテキストはアプリのUserDataディレクトリにファイルキャッシュとして保存
- チャット機能
  - AIエージェントが以下のツールを利用しながらユーザの指示に対応する
    - ドキュメント検索ツール
    - GitLab操作ツール
    - Redmine操作ツール
    - MCP連携
- ドキュメントレビュー機能
  - チェックリストをあるドキュメントから抽出して、そのリストを元に別のドキュメントのレビューを実行する機能
    - サブ機能は以下（Mastraのworkflowを利用して実装）
      - チェックリスト抽出機能
        - チェックリストドキュメントからのチェックリスト項目抽出機能
        - 一般ドキュメントからのチェックリスト項目作成機能
      - （上記で抽出したチェックリスト項目に対して）ドキュメントレビュー実行機能

### 技術スタック
- **フレームワーク**: Electron(electron-react-boilerplate) + React + TypeScript
- **UI**: Material-UI (MUI)
- **データベース**: SQLite (Drizzle ORM)  
- **AIフレームワーク**: Mastra（エージェント・ワークフロー管理）
- **バンドラー**: Webpack
- **テスト**: Jest + Testing Library

### アーキテクチャ階層

#### 1. Electronプロセス
- **メインプロセス** (`src/main/main.ts`): アプリケーションのエントリーポイント、IPC通信管理
- **レンダラープロセス** (`src/renderer/`): Reactベースのフロントエンド UI
  - レイアウトは`src/renderer/App.tsx`で定義しており、各機能はsrc/renderer/components/sidebar/SidebarHeader.tsxで切り替え

#### 2. Mastraフレームワーク統合 (`src/mastra/`)
- **エージェント**（`src/mastra/agents`）: 特定のタスクを実行するAgent
- **ツール**（`src/mastra/tools`）: 外部システム（GitLab、Redmine、MCP）との統合
- **ワークフロー**（`src/mastra/workflows`）: 複雑なタスクの自動化フロー

#### 3. データベース層 (`src/db/`)
- **スキーマ**（`src/db/schema.ts`）: Drizzleで定義されたテーブル構造
- **リポジトリ**（`src/db/repository`）: データアクセス層
- SQLiteベースの軽量データベース

#### 4. サービス層 (`src/main/service/`)
- **ChatService**: チャット機能のビジネスロジック
- **ReviewService**: レビュー機能のビジネスロジック  
- **SettingsService**: アプリケーション設定管理

### IPC通信パターン
ElectronのIPCを使用してフロントエンド・バックエンド間の通信を実装。チャネル定義は`src/main/types/ipc.ts`で管理。

### 設定管理
- Electron-storeを使用したアプリケーション設定の永続化
- 環境変数とランタイム設定の分離

### その他代表的なフォルダ・ファイル
- `src/main/types`：アプリで利用する型・zodスキーマの定義
  - `index.ts`：アプリ全体で利用する型定義
  - `ipc.ts`：Electron IPC通信で利用する型定義
- `src/main`: Electronのメインプロセス関連のコード
  - `src/main.ts`: Electronのメインプロセスのエントリポイント、IPC通信のハンドラの具体的な処理の定義やアプリケーションの初期化処理などを含む
  - `src/main/preload`: ElectronのPreloadスクリプト、レンダラープロセスに公開するハンドラを定義
  - `src/main/store.ts`: electron-storeを利用してアプリケーションの設定や状態の保存・取得を行う、ここではstoreの初期化や設定の定義を行う
  - `src/main/utils`: メインプロセスで利用するユーティリティ関数
    - `src/main/utils/fileExtractor.ts`: 登録されたソースのテキスト情報を抽出する関数
- `src/renderer/components`：Reactコンポーネント
  - `src/renderer/components/chat`: チャット機能のコンポーネント
  - `src/renderer/components/review`: レビュー機能のコンポーネント
  - `src/renderer/components/chat`: チャット機能のコンポーネント
  - `src/renderer/components/common`: アプリ共通のコンポーネント
  - `src/renderer/components/sidebar`: サイドバー共通のコンポーネント
  - `src/renderer/hooks`: フック定義をまとめたディレクトリ
  - `src/renderer/service`: フロントエンドから利用するサービス定義をまとめたディレクトリ
  - `src/renderer/stores`: zustandで管理するstate定義
- `src/mastra`: Mastraを利用したAI関連のコード
  - `src/mastra/agents/prompt.ts`: Mastraのエージェントのプロンプト定義を一箇所に集約（エージェントやワークフロー内で利用するプロンプトを定義）
  - `src/mastra/agents/orchestrator.ts`: 汎用チャット機能で利用するAIエージェントの定義
  - `src/mastra/workflows`: Mastraのワークフロー定義
    - `src/mastra/workflows/sourceRegistration`: ドキュメントのテキスト抽出用のワークフロー定義
    - `src/mastra/workflows/sourceReview`: ドキュメントレビュー用のワークフロー定義
    - `src/mastra/workflows/types.ts`: ワークフローで利用する型定義
    - `src/mastra/workflows/schema.ts`: ワークフローで利用するzodスキーマ定義（ワークフローを作成する際は、各Stepのoutputschemaは必ず本ファイル内に定義されているbaseStepOutputSchemaを継承するようにしてください）

## テスト作成時の注意
- 明確な指示がある場合以外はテストコードを作成しないこと
- 外部ライブラリとの結合をテストする場合はできるだけ実際のライブラリを使用すること
  - 実際のライブラリの利用が難しい場合はモックを利用すること
  - Electron IPCはモックを利用すること
    - モックの実装はsrc/__tests__/test-utils/mockElectronHandler.tsに集約させること
- 下記の観点からテストを作成すること
  - ビジネス的な観点
    - 正常系
    - 異常系
  - 技術的な観点
    - 正常系
    - 異常系
- テストに関連するプロダクトコードのカバレッジを100%にすること
- テスト関連コードはsrc/__test__に配置すること
- テストは古典派的なスタイルで記述すること
  - つまり、単体テストはクラス単位ではなく、一つの振る舞い単位で記述すること
- テストの説明は日本語で記述すること
  - テストの説明は、何をテストしているのか、どのような条件でテストが行われるのかを明確に記述すること
- テストの書き方で不明点があれば次のディレクトリ配下のテストコードを参考にすること
  - src/__tests__/integration

## 実装上の注意
- Mastraについては実装する際はまずMCPでドキュメントや実装例を参考にしてから正確な情報やベストプラクティスに基づいてコーディングすること
- Mastra workflowの作成時は既存のスタイルを踏襲すること
- プロジェクト全体を把握して、全ての実装が必要箇所を正しく洗い出してから実装すること
- 既存資源（型情報やコンポーネントなど）を積極的に活用して効率的に実装すること
  - 既存のコードの修正は真に必要な場合に限ること
- UIは実際に市場に投入できるくらいレベルの高いUIにすること
- TypeScriptを利用して型安全なコードにすること
- プロンプトは英語で記載すること
  - プロンプトの内容は経験豊富なプロンプトエンジニアとしてベストプラクティスに基づいて実装すること
  - 一般的で自然な英語表現にすること
- コードのコメントは日本語で記載すること
- Reactライブラリが使えるのであれば積極的に利用すること
    - 特にUIについてはMUIを第一優先に使い、カスタマイズしたい場合はshadcn/uiを利用すること
    - ライブラリを追加する際は安定稼働バージョンを採用すること
- eslintについては単純なフォーマットエラーの場合は対応する必要はない
- 将来的に本アプリをwebアプリとして利用した場合に、利用者ごとに状態を保持しなければならないような処理の場合はクラスを利用し、アプリで一つの状態を保持するような場合にはモジュールとしてシングルトン変数や関数を利用すること
- テストについては指示されない限り、実行も修正もしなくてよい

## 依頼タスク
### 要件
1. ドキュメントレビューで、チェックリスト作成やチェック実行をする際のドキュメント指定方法を変更し、従来の選択方式からファイルアップロード機能に変更する
  - 複数ファイルをアップロード可能
2. アップロードするファイルがPDFの場合は、テキスト情報を抽出するか、画像として送信するか選択することができる

### UI要件
- モーダルの変更(`src/renderer/components/review/ReviewSourceModal.tsx`)
  - 従来の登録済みドキュメントの選択方式は完全に削除
  - ファイルアップロードボタン追加(複数ファイル選択可能)
  - アップロード予定のファイル一覧表示
    - ファイル名を確認可能(パスは不要)
    - 特定ファイルを指定して送信対象から削除することも可能
    - ファイルがPDFの場合は画像かテキスト抽出か選択可能
      - ツールチップで「ファイルが図形オブジェクトを多数含んでいる場合は画像で送信することで精度が上がる場合があります」と表示すること
  - ファイルアップロードにした場合も、登録済みドキュメント選択方式の場合と変わらないユーザ体験になるようにすること
    - チェックリスト抽出やチェック実行を実行中の場合は、モーダル内のボタンが非活性になり、特定ボタンについてはローディングを表示する
    - 実行完了の際はその旨を通知する

### 要件実装時の注意
- ファイルアップロードについては、画像化PDFを除き、Mainプロセスに選択されたファイルのパスを送ること（Mainプロセスにパスからテキストを抽出する仕組みが整えてあるため）
  - Mainプロセスでは連携されたパスをファイルテキスト抽出処理(`src/main/utils/fileExtractor.ts`)に渡すだけでテキスト抽出処理ができるはず
    - ただし、レビュー機能ではファイルキャッシュしないこと
  - ブラウザでの絶対パスの取得について
    - 通常のブラウザAPIでは取得不可なので、electronの機能を利用すること
- PDFを画像としてアップロードする場合に限り、ブラウザ内でPDFを画像に変換しMainプロセスに送り、その画像をAIに送信すること
  - （現在インストールされていて、`src/main/utils/fileExtractor.ts`で利用されている）pdfjs-distを利用してください
  - AIに画像を送信する方法についてはMastraのMCPを参照して確認すること
- workflowも忘れずに修正すること
