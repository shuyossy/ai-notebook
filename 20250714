build:
  stage: build
  image: node:16-alpine
  script:
    - npm install
    - npm run package
  artifacts:
    paths:
      - "*.vsix"

publish_vsix:
  stage: deploy
  image: curlimages/curl:latest
  needs:
    - build
  script:
    # 生成された VSIX ファイルを検出
    - VSIX_FILE=$(ls *.vsix)
    # package.json から version を取得
    - VERSION=$(node -p "require('./package.json').version")
    - echo "Publishing ${VSIX_FILE} as ${PACKAGE_NAME}/${VERSION}"
    # Generic Packages API でアップロード
    - |
      curl --location --header "JOB-TOKEN: ${CI_JOB_TOKEN}" \
           --upload-file "${VSIX_FILE}" \
           "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/${PACKAGE_NAME}/${VERSION}/${VSIX_FILE}"
  rules:
    # すべてのブランチで実行したい場合
    - if: $CI_COMMIT_BRANCH
      when: on_success
